pipeline {
  agent any

  tools {
    maven 'maven3'
    jdk 'java11'
  }

  environment {
    IMAGE_NAME = "abhayt7/studentapp"
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/abhayt7/Real-Time-DevOps-CI-CD-Project-.git'
      }
    }

    stage('Build') {
      steps {
        dir('app') {
          sh 'mvn clean package'
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withSonarQubeEnv('sonar') {
          dir('app') {
            sh 'mvn sonar:sonar -Dsonar.projectKey=real-time-devops-project'
          }
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        dir('app') {
          withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'DOCKERHUB_PASSWORD', usernameVariable: 'DOCKERHUB_USERNAME')]) {
            sh '''
              docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
              docker build -t $IMAGE_NAME:latest .
              docker push $IMAGE_NAME:latest
            '''
          }
        }
      }
    }

  }

  post {
    success { echo "Pipeline SUCCESS ✅" }
    failure { echo "Pipeline FAILED ❌" }
  }
}
